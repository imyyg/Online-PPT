# Change: 添加邮箱验证码验证功能

## Why

当前系统允许用户直接通过邮箱注册账号，无需验证邮箱真实性和所有权，存在以下问题：
1. 恶意用户可以使用虚假或他人邮箱注册，影响系统安全性和数据质量
2. 无法确认用户是否拥有邮箱访问权限，可能导致账号纠纷
3. 缺乏账号找回和重要通知的可靠渠道

通过添加邮箱验证码功能，在注册流程中验证邮箱真实性，可以提升账号安全性，建立可信的用户身份基础。

## What Changes

### 新增功能
- 引入 Redis 作为缓存服务（存储验证码和频率限制数据）
- 添加图形验证码生成和验证（防机器人，存储在 Redis 中）
- 添加邮箱验证码生成、Redis 缓存和验证机制（6位数字码，有效期10分钟）
- 实现 SMTP 邮件发送服务，支持通过配置文件灵活配置邮件服务器
- 新增 `GET /api/v1/auth/captcha` 端点用于获取图形验证码
- 新增 `POST /api/v1/auth/send-verification-code` 端点用于发送邮箱验证码（需先验证图形验证码）
- 添加验证码发送频率限制（60秒内不可重复发送至同一邮箱，基于 Redis）
- 添加验证失败次数限制（防止暴力破解，最多尝试5次）

### 调整现有功能
- **MODIFIED** 注册流程：用户需先通过图形验证码 → 发送邮箱验证码 → 提交注册时验证邮箱验证码 → 创建账号（状态为 active）
- **NO CHANGE** 登录流程：保持现有逻辑不变
- **NO CHANGE** 数据库用户表：无需修改，不引入 pending 状态

### 配置变更
- 在 `configs/app.yaml` 中新增 SMTP 邮件服务配置项
- 提供 SMTP 配置指导文档

## Impact

### 受影响的规范
- **User Authentication (auth)**: 添加图形验证码和邮箱验证码验证流程，修改注册逻辑
- **Configuration**: 新增邮件服务配置

### 受影响的代码
- `internal/auth/service.go` - 修改注册逻辑，添加验证码验证
- `internal/http/handlers/auth_handlers.go` - 修改注册端点，新增验证码相关端点
- `internal/config/config.go` - 添加 SMTP 和 Redis 配置结构
- 新增 `internal/mail/` 包处理邮件发送
- 新增 `internal/captcha/` 包处理图形验证码
- 新增 `internal/cache/` 包处理 Redis 缓存操作
- `go.mod` - 添加 Redis 客户端库依赖

### 破坏性变更
- **BREAKING** 注册接口 `POST /api/v1/auth/register` 的请求参数变更：
  - 新增必填字段：`captcha_id` 和 `captcha_code`（图形验证码）
  - 新增必填字段：`email_code`（邮箱验证码）
- 客户端需要先调用获取图形验证码接口，再调用发送邮箱验证码接口，最后调用注册接口

## Risks & Mitigations

### 风险
1. SMTP 配置错误导致邮件发送失败
2. 邮件服务商可能将验证邮件判定为垃圾邮件
3. Redis 服务不可用导致验证码功能失效
4. Redis 连接数耗尽影响性能
5. 图形验证码可能被 OCR 识别破解

### 缓解措施
1. 提供详细的 SMTP 配置指导和常见邮件服务提供商配置示例
2. 邮件模板设计遵循最佳实践，添加 SPF/DKIM 配置建议
3. 实现 Redis 健康检查和自动重连机制；提供 Docker Compose 快速部署
4. 配置合理的 Redis 连接池大小（默认10个连接）
5. 图形验证码使用干扰线和噪点，必要时可增加难度或引入滑块验证

## Alternatives Considered

### 方案1：使用内存缓存而非 Redis
- 优点：无需额外服务，实现简单
- 缺点：服务重启丢失数据，无法支持分布式部署，功能有限
- 决策：使用 Redis 获得更好的可靠性和可扩展性

### 方案2：使用数据库存储验证码
- 优点：持久化存储，可审计
- 缺点：性能较差，需要清理任务，增加数据库负载
- 决策：使用 Redis 获得更好的性能和自动过期功能

### 方案3：使用第三方邮件验证服务（如 SendGrid、阿里云邮件推送）
- 优点：更可靠的送达率，更好的监控和日志
- 缺点：引入额外依赖和成本，配置相对复杂
- 决策：先实现 SMTP 基础方案，未来可扩展支持第三方服务

### 方案4：邮件链接验证而非验证码
- 优点：用户体验更简单（点击链接即可）
- 缺点：需要实现 token 生成和验证，对移动端不够友好
- 决策：验证码方式更灵活，适合多端场景
