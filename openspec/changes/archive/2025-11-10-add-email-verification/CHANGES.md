# é‚®ç®±éªŒè¯ç åŠŸèƒ½ - æ–¹æ¡ˆæ›´æ–°æ€»ç»“

## ğŸ”„ ä¸»è¦å˜æ›´

æ ¹æ®è®¨è®ºï¼Œå¯¹åŸææ¡ˆè¿›è¡Œäº†ä»¥ä¸‹é‡è¦è°ƒæ•´ï¼š

### 1. éªŒè¯ç å­˜å‚¨æ–¹å¼ï¼šæ•°æ®åº“ â†’ Redis ç¼“å­˜

**åŸæ–¹æ¡ˆ**: éªŒè¯ç å­˜å‚¨åœ¨ MySQL æ•°æ®åº“è¡¨ä¸­  
**æ–°æ–¹æ¡ˆ**: éªŒè¯ç å­˜å‚¨åœ¨ Redis ç¼“å­˜ä¸­

**ä¼˜åŠ¿**:
- âœ… æ€§èƒ½æ›´å¥½ï¼ˆå†…å­˜è®¿é—® vs æ•°æ®åº“æŸ¥è¯¢ï¼‰
- âœ… åŸç”Ÿ TTL æ”¯æŒï¼ˆè‡ªåŠ¨è¿‡æœŸï¼‰
- âœ… æ— éœ€æ¸…ç†ä»»åŠ¡
- âœ… ç®€åŒ–ç³»ç»Ÿè®¾è®¡ï¼ˆæ— éœ€æ–°è¡¨å’Œè¿ç§»ï¼‰
- âœ… æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²ï¼ˆå¤šå®ä¾‹å…±äº«ç¼“å­˜ï¼‰
- âœ… æ•°æ®æŒä¹…åŒ–ï¼ˆå¯é€‰ï¼ŒRDB/AOFï¼‰
- âœ… ä¸°å¯Œçš„æ•°æ®ç»“æ„ï¼ˆString, Hash, Set ç­‰ï¼‰

**å®ç°**: ä½¿ç”¨ `github.com/redis/go-redis/v9` å®¢æˆ·ç«¯åº“

---

### 2. æ³¨å†Œæµç¨‹ï¼šä¸¤æ­¥éªŒè¯ â†’ ä¸‰æ­¥éªŒè¯

**åŸæ–¹æ¡ˆ**: æ³¨å†Œ â†’ éªŒè¯é‚®ç®± â†’ æ¿€æ´»è´¦å·ï¼ˆpending â†’ activeï¼‰  
**æ–°æ–¹æ¡ˆ**: è·å–å›¾å½¢éªŒè¯ç  â†’ å‘é€é‚®ç®±éªŒè¯ç  â†’ æ³¨å†Œï¼ˆç›´æ¥ activeï¼‰

**æ–°æµç¨‹**:
```
1. ç”¨æˆ·è®¿é—®æ³¨å†Œé¡µé¢
   â†“
2. è·å–å›¾å½¢éªŒè¯ç  (GET /api/v1/auth/captcha)
   â†“
3. å¡«å†™ï¼šé‚®ç®± + å¯†ç  + å›¾å½¢éªŒè¯ç 
   â†“
4. ç‚¹å‡»"å‘é€éªŒè¯ç " (POST /api/v1/auth/send-verification-code)
   â†“
5. æŸ¥æ”¶é‚®ä»¶ï¼Œå¡«å†™6ä½é‚®ç®±éªŒè¯ç 
   â†“
6. ç‚¹å‡»"æ³¨å†Œ" (POST /api/v1/auth/register)
   â†“
7. ç³»ç»ŸéªŒè¯é‚®ç®±éªŒè¯ç ï¼Œåˆ›å»ºè´¦å·ï¼ˆstatus: activeï¼‰
```

**ä¼˜åŠ¿**:
- âœ… æ— éœ€ pending çŠ¶æ€ï¼Œç®€åŒ–ç”¨æˆ·çŠ¶æ€ç®¡ç†
- âœ… å›¾å½¢éªŒè¯ç é˜²æ­¢æœºå™¨äººæ»¥ç”¨
- âœ… ç”¨æˆ·ä½“éªŒæ›´æµç•…ï¼ˆæ— éœ€é¢å¤–æ¿€æ´»æ­¥éª¤ï¼‰

---

### 3. å–æ¶ˆ pending çŠ¶æ€

**åŸæ–¹æ¡ˆ**: å¼•å…¥ `pending` çŠ¶æ€ï¼Œç”¨æˆ·æ³¨å†Œåéœ€éªŒè¯é‚®ç®±æ‰èƒ½æ¿€æ´»  
**æ–°æ–¹æ¡ˆ**: ä¿æŒç°æœ‰çŠ¶æ€è®¾è®¡ï¼Œä»…ä½¿ç”¨ `active` å’Œ `locked`

**ç†ç”±**:
- å½“å‰æ˜¯å¼€å‘é˜¶æ®µï¼Œæ— å·²æ³¨å†Œä½†æœªéªŒè¯çš„ç”¨æˆ·
- ç®€åŒ–ç³»ç»Ÿé€»è¾‘ï¼Œå‡å°‘çŠ¶æ€è½¬æ¢
- ç™»å½•æµç¨‹æ— éœ€ä¿®æ”¹

---

## ğŸ“‹ æ–°çš„ API è®¾è®¡

### 1. è·å–å›¾å½¢éªŒè¯ç ï¼ˆæ–°å¢ï¼‰

```http
GET /api/v1/auth/captcha
```

**å“åº”**:
```json
{
  "captcha_id": "uuid",
  "image": "data:image/png;base64,...",
  "expires_in": 300
}
```

---

### 2. å‘é€é‚®ç®±éªŒè¯ç ï¼ˆæ–°å¢ï¼‰

```http
POST /api/v1/auth/send-verification-code
```

**è¯·æ±‚**:
```json
{
  "email": "user@example.com",
  "captcha_id": "uuid",
  "captcha_code": "AB12"
}
```

**å“åº”**:
```json
{
  "message": "éªŒè¯ç å·²å‘é€",
  "expires_in": 600
}
```

---

### 3. æ³¨å†Œï¼ˆä¿®æ”¹ï¼‰

```http
POST /api/v1/auth/register
```

**è¯·æ±‚**ï¼ˆæ–°å¢ `email_code` å­—æ®µï¼‰:
```json
{
  "email": "user@example.com",
  "password": "SecurePass123!",
  "email_code": "123456"
}
```

**å“åº”**ï¼ˆä¿æŒä¸å˜ï¼‰:
```json
{
  "user": {
    "uuid": "uuid",
    "email": "user@example.com",
    "status": "active",
    "created_at": "2025-11-10T10:00:00Z"
  },
  "access_token": "jwt_token",
  "expires_at": "2025-11-10T10:15:00Z"
}
```

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### Redis æ•°æ®ç»“æ„

```go
// å›¾å½¢éªŒè¯ç 
// Key: "captcha:{captcha_id}"
// Value: "AB12" (éªŒè¯ç å­—ç¬¦ä¸²)
// TTL: 5åˆ†é’Ÿ

// é‚®ç®±éªŒè¯ç 
// Key: "email_code:{email}"
// Value: JSON {"code":"123456","attempts":0,"created_at":"2025-11-10T10:00:00Z"}
// TTL: 10åˆ†é’Ÿ

// å‘é€é¢‘ç‡é™åˆ¶
// Key: "rate_limit:{email}"
// Value: "1" (ä»»æ„å€¼)
// TTL: 60ç§’
```

**Redis å‘½ä»¤ç¤ºä¾‹**:
```redis
# å­˜å‚¨å›¾å½¢éªŒè¯ç 
SET captcha:uuid "AB12" EX 300

# å­˜å‚¨é‚®ç®±éªŒè¯ç 
SET email_code:user@example.com '{"code":"123456","attempts":0}' EX 600

# è®¾ç½®é¢‘ç‡é™åˆ¶
SET rate_limit:user@example.com "1" EX 60

# æ£€æŸ¥é¢‘ç‡é™åˆ¶
EXISTS rate_limit:user@example.com
```

### ç»„ä»¶æ¶æ„

```
HTTP Handler
    â”œâ”€â”€ GET /captcha â†’ Captcha Service â†’ Redis
    â”œâ”€â”€ POST /send-code â†’ Auth Service â†’ Mail Service
    â”‚                   â†“
    â”‚              Redis (verify captcha)
    â””â”€â”€ POST /register â†’ Auth Service â†’ Repository
                       â†“
                  Redis (verify email code)
```

**å¤–éƒ¨ä¾èµ–**:
- Redis 6.0+ (æ”¯æŒ ACL, æ›´å¥½çš„æ€§èƒ½)
- `github.com/redis/go-redis/v9` (Go Redis å®¢æˆ·ç«¯)

---

## âœ… å®‰å…¨æªæ–½

### å¤šå±‚é˜²æŠ¤

1. **å›¾å½¢éªŒè¯ç **: é˜²æ­¢è‡ªåŠ¨åŒ–è„šæœ¬ï¼ˆ5åˆ†é’Ÿæœ‰æ•ˆï¼Œä¸€æ¬¡æ€§ä½¿ç”¨ï¼‰
2. **å‘é€é¢‘ç‡é™åˆ¶**: åŒä¸€é‚®ç®±60ç§’å†…åªèƒ½å‘é€ä¸€æ¬¡
3. **éªŒè¯å°è¯•é™åˆ¶**: æ¯ä¸ªéªŒè¯ç æœ€å¤šå°è¯•5æ¬¡
4. **è‡ªåŠ¨è¿‡æœŸ**: é‚®ç®±éªŒè¯ç 10åˆ†é’Ÿåå¤±æ•ˆ
5. **å¸¸é‡æ—¶é—´æ¯”è¾ƒ**: é˜²æ­¢æ—¶åºæ”»å‡»
6. **åŠ å¯†éšæœºæ•°**: ä½¿ç”¨ crypto/rand ç”ŸæˆéªŒè¯ç 

---

## ğŸ“¦ å®æ–½èŒƒå›´

### æ–°å¢ç»„ä»¶

- `internal/captcha/` - å›¾å½¢éªŒè¯ç ç”Ÿæˆå’ŒéªŒè¯
- `internal/cache/` - Redis ç¼“å­˜ç®¡ç†ï¼ˆå°è£… Redis å®¢æˆ·ç«¯ï¼‰
- `internal/mail/` - SMTP é‚®ä»¶å‘é€

### ä¿®æ”¹ç»„ä»¶

- `internal/auth/service.go` - æ·»åŠ éªŒè¯ç éªŒè¯é€»è¾‘
- `internal/http/handlers/auth_handlers.go` - æ–°å¢ç«¯ç‚¹ï¼Œä¿®æ”¹æ³¨å†Œé€»è¾‘
- `internal/config/config.go` - æ·»åŠ  SMTP å’Œ Redis é…ç½®

### æ–°å¢åŸºç¡€è®¾æ–½

- Redis æœåŠ¡å™¨ï¼ˆå¼€å‘ç¯å¢ƒå¯ç”¨ Dockerï¼‰
- Redis é…ç½®å’Œè¿æ¥ç®¡ç†

### æ— éœ€ä¿®æ”¹

- æ•°æ®åº“è¡¨ç»“æ„ï¼ˆæ— éœ€æ–°è¡¨æˆ–è¿ç§»ï¼‰
- ç™»å½•æµç¨‹ï¼ˆä¿æŒä¸å˜ï¼‰
- ç”¨æˆ·çŠ¶æ€ç®¡ç†ï¼ˆæ—  pending çŠ¶æ€ï¼‰

---

## ğŸš§ ç ´åæ€§å˜æ›´

### API Breaking Changes

**æ³¨å†Œæ¥å£å‚æ•°å˜æ›´**:

| ç‰ˆæœ¬ | å¿…å¡«å­—æ®µ |
|-----|---------|
| Before | `email`, `password` |
| After | `email`, `password`, `email_code` |

**å®¢æˆ·ç«¯è¿ç§»å¿…éœ€**:
1. æ·»åŠ å›¾å½¢éªŒè¯ç è·å–å’Œæ˜¾ç¤º
2. æ·»åŠ å‘é€é‚®ç®±éªŒè¯ç æŒ‰é’®
3. æ·»åŠ é‚®ç®±éªŒè¯ç è¾“å…¥æ¡†
4. æ³¨å†Œè¯·æ±‚åŒ…å« `email_code` å­—æ®µ

---

## ğŸ“ æ–‡æ¡£ç»“æ„

```
openspec/changes/add-email-verification/
â”œâ”€â”€ proposal.md (å·²æ›´æ–°)
â”œâ”€â”€ design.md (å·²æ›´æ–°)
â”œâ”€â”€ tasks.md (å¾…æ›´æ–°)
â””â”€â”€ specs/
    â”œâ”€â”€ email-verification/
    â”‚   â”œâ”€â”€ spec.md (æ—§ç‰ˆï¼Œä¿ç•™)
    â”‚   â””â”€â”€ spec-v2.md (æ–°ç‰ˆï¼Œç®€åŒ–)
    â””â”€â”€ auth/
        â”œâ”€â”€ spec.md (æ—§ç‰ˆï¼Œä¿ç•™)
        â””â”€â”€ spec-v2.md (æ–°ç‰ˆï¼Œç®€åŒ–)
```

---

## â­ï¸ ä¸‹ä¸€æ­¥

1. **å®¡é˜…ç®€åŒ–æ–¹æ¡ˆ**: ç¡®è®¤æ–°æ–¹æ¡ˆç¬¦åˆéœ€æ±‚
2. **æ›´æ–° tasks.md**: åŸºäºæ–°æ–¹æ¡ˆé‡å†™å®æ–½ä»»åŠ¡
3. **é€‰æ‹©å›¾å½¢éªŒè¯ç åº“**: æ¨è `github.com/dchest/captcha`
4. **é…ç½® SMTP**: å‡†å¤‡é‚®ä»¶æœåŠ¡é…ç½®
5. **å¼€å§‹å®æ–½**: æŒ‰ç…§æ–°çš„ tasks é€æ­¥å®ç°

---

## ğŸ¤” å¾…ç¡®è®¤é—®é¢˜

1. **å›¾å½¢éªŒè¯ç åº“é€‰æ‹©**: 
   - ä½¿ç”¨ç°æˆçš„åº“ï¼ˆå¦‚ `dchest/captcha`ï¼‰
   - è¿˜æ˜¯è‡ªå·±å®ç°ç®€å•ç‰ˆæœ¬ï¼Ÿ

2. **Redis é…ç½®**:
   - å¼€å‘ç¯å¢ƒä½¿ç”¨ Docker è¿˜æ˜¯æœ¬åœ°å®‰è£…ï¼Ÿ
   - Redis å¯†ç å’Œ ACL é…ç½®ï¼Ÿ
   - æ˜¯å¦å¯ç”¨æŒä¹…åŒ–ï¼ˆRDB/AOFï¼‰ï¼Ÿ

3. **é‚®ä»¶æ¨¡æ¿**:
   - æ˜¯å¦éœ€è¦æ”¯æŒ HTML å’Œçº¯æ–‡æœ¬ä¸¤ç§æ ¼å¼ï¼Ÿ
   - æ˜¯å¦éœ€è¦å“ç‰Œæ ·å¼ï¼Ÿ

4. **é”™è¯¯æç¤º**:
   - éªŒè¯ç é”™è¯¯æ—¶æ˜¯å¦è¦æ˜¾ç¤ºå‰©ä½™å°è¯•æ¬¡æ•°ï¼Ÿ
   - å¦‚ä½•å¹³è¡¡å®‰å…¨æ€§å’Œç”¨æˆ·ä½“éªŒï¼Ÿ
