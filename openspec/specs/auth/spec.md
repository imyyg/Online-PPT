# Capability: Authentication

## Purpose

用户认证能力,提供注册、登录和令牌管理功能。
## Requirements
### Requirement: 用户注册

系统 SHALL 允许用户通过邮箱和密码注册账号。

#### Scenario: 基本注册流程

- **GIVEN** 用户提供有效的邮箱和密码
- **WHEN** 用户提交注册请求
- **THEN** 系统创建新用户账号（状态为 active）
- **AND** 返回用户信息和访问令牌

#### Scenario: 邮箱格式验证

- **GIVEN** 用户提供的邮箱格式不正确
- **WHEN** 用户提交注册请求
- **THEN** 系统返回 400 错误
- **AND** 提示邮箱格式无效

#### Scenario: 邮箱已注册

- **GIVEN** 用户提供的邮箱已被注册
- **WHEN** 用户提交注册请求
- **THEN** 系统返回 409 错误
- **AND** 提示邮箱已被使用

### Requirement: 用户登录

系统 SHALL 允许已注册用户通过邮箱和密码登录。

#### Scenario: 成功登录

- **GIVEN** 用户提供正确的邮箱和密码
- **WHEN** 用户提交登录请求
- **THEN** 系统验证凭证
- **AND** 返回访问令牌和刷新令牌

#### Scenario: 凭证错误

- **GIVEN** 用户提供错误的邮箱或密码
- **WHEN** 用户提交登录请求
- **THEN** 系统返回 401 错误
- **AND** 提示凭证无效

### Requirement: 密码安全

系统 SHALL 使用 Argon2id 算法加密存储用户密码。

#### Scenario: 密码哈希

- **GIVEN** 用户注册或修改密码
- **WHEN** 系统存储密码
- **THEN** 系统使用 Argon2id 算法生成哈希
- **AND** 仅存储哈希值，不存储明文密码

### Requirement: 令牌管理

系统 SHALL 使用 JWT 令牌进行会话管理，提供访问令牌和刷新令牌。

#### Scenario: 令牌生成

- **GIVEN** 用户成功登录或注册
- **WHEN** 系统创建会话
- **THEN** 系统生成访问令牌（有效期15分钟）
- **AND** 生成刷新令牌（有效期7天）

#### Scenario: 令牌刷新

- **GIVEN** 用户的访问令牌过期
- **WHEN** 用户使用有效的刷新令牌请求新访问令牌
- **THEN** 系统验证刷新令牌
- **AND** 返回新的访问令牌

### Requirement: 带邮箱验证的注册流程

系统 SHALL 提供基于邮箱验证码的注册流程,确保用户拥有邮箱访问权限。

#### Scenario: 验证码注册流程

- **GIVEN** 用户需要注册新账号
- **WHEN** 用户完成以下步骤:
  1. 获取图形验证码
  2. 使用图形验证码请求发送邮箱验证码
  3. 查收邮件获取6位数字验证码
  4. 提交邮箱、密码和邮箱验证码完成注册
- **THEN** 系统验证邮箱验证码的有效性
- **AND** 验证成功后创建账号(状态为 active)
- **AND** 返回用户信息和访问令牌

#### Scenario: 邮箱验证码无效

- **GIVEN** 用户提供错误的邮箱验证码
- **WHEN** 用户提交注册请求
- **THEN** 系统返回 400 错误
- **AND** 提示验证码无效或已过期

#### Scenario: 超过验证尝试次数

- **GIVEN** 用户已失败验证5次
- **WHEN** 用户再次尝试注册
- **THEN** 系统返回 429 错误
- **AND** 提示验证码已失效,需重新获取

